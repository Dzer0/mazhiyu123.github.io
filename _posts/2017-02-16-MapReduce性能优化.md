---
published: true
layout: post
title: MapReduce性能优化
category: Hadoop
tags: 
  - Hadoop
time: 2017.02.16 09:54:00
excerpt: 推测执行采用经典的优化方式：以空间换时间。它是对执行进度明显慢于其他任务的个别任务所采取的优化方式。也就是对执行进度慢的任务，在另外的一个节点上启动一个备份任务。原任务和备份任务哪个任务先执行完成都算这个任务执行成功了。 
---

##### MapReduce性能优化
对MapReduce处理过程进行调优一直都是只有更好没有最好。因此，性能调优也是关注的重点。总的来说，调优应该遵循以下几条基本原则：  
1. 保证运行中的Job足够的计算资源和存储资源。
2. 对在执行的作业，提高并行度
3. 在保证前两条原则的情况下，尽可能的为Shuffle阶段提供所需的资源。  

有了指导的的原则，本文总结出来一些调优的具体措施。   

1. 启动推测执行机制  
推测执行采用经典的优化方式：以空间换时间。它是对执行进度明显慢于其他任务的个别任务所采取的优化方式。也就是对执行进度慢的任务，在另外的一个节点上启动一个备份任务。原任务和备份任务哪个任务先执行完成都算这个任务执行成功了。  

2. 使用分布式缓存功能  
分布式缓存功能是将一些程序中需要的外部数据文件(比如作业的配置文件，数据字典等)分发到各个节点上。  
当用户的应用程序需要一个外部文件(比如字典、配置文件等)时，通常需要使用分布式缓存将文件分发到各个节点上。一般情况下，有两种方式可以将外部文件导入到集群中。第一种方式是将外部文件和应用程序的jar包一起导入到客户端，在客户端提交作业的时候，会将它们一起上传到HDFS的一个目录下，然后由DistributedCache把它们分发到各个节点上。第二种方式是让外部文件不经过客户端而是直接导入到HDFS中。第二种方式要比第一种方式更加高效。因为第二种方式不仅将客户端上传文件到HDFS的时间节省了，而且还隐含的告诉DistributedCache，它需要将外部文件分发到各个节点的public级别的目录而不是private界别的目录。外部文件放到public级别的目录下，后续的所有作业如果用到了相同的外部文件它可以不用重新下载，直接使用已经下载好的外部文件即可。  

3. 合理控制ReduceTask的启动时间  
从处理逻辑上看，在MapReduce计算框架中ReduceTask需要使用MapTask的处理结果，因此它的启动时间应该晚于MapTask的启动时间。但是这里所说的ReduceTask晚于MapTask启动在时间轴上看并不是线性的，两者是有重叠的。也就是ReduceTask的启动不必等到所有的MapTask都运行完成，它可以在只有一部分MapTask运行完成的时候就启动运行。这里‘一部分MapTask’的多少就是调优时候的重点关注对象。如果设置的过大，会导致ReduceTask启动时机延迟使其获取计算资源和存储资源的时间较晚，从而增加了运行时间。如果设置的过小，ReduceTask会提前启动并获取了计算资源和存储资源，但是由于没有数据ReduceTask并不会真正运行，它会长时间的占用获取到的资源从而造成资源的浪费降低了资源利用率。如果设置的较为可合理，不仅可以加快作业运行速度，而且可提高系统资源利用率。  

4. 设置可跳过坏记录  
由于MapReduce大多数情况都需要处理大量数据，少量数据的丢失并不会对最终的结果产生很大的影响。因此，设置为可跳过坏记录可以在保证正确结果的前提下让Job可以顺利运行完成。  

5. 适当增加HDFS中的文件副本数
当大量任务同时读取一个文件时，可能造成IO阻塞，从而影响任务的执行进度。增加文件副本数可以将大量的读请求分散到不同节点上以减轻单个节点的IO压力  

6. 根据不同Job的实际情况合理设置任务的数量。
集群中，一个作业的任务(MapTask,ReduceTask)数量对作业的运行时间有着重要的影响。如果一个作业的任务数量过少，会使每个作业处理的数据较多执行时间较长但是会减少任务启动、资源请求、数据传输的时间。如果任务数量过多，各种处理流程花费的时间则恰好与任务数量过少的情况相反。根据具体的作业设置合理任务数量是调优过程中的重点和难点。  

7. 对数据的IO选择合适的压缩算法  
运行在Hadoop平台上的应用多为IO密集型。程序运行阶段会产生大量中间结果。如果对这些数据进行压缩，会减少需要传输的数据量，明显提升系统的IO性能。在选择压缩算法的时候，需要考虑压缩比和压缩效率两个因素。有的压缩算法有很好的压缩比，但压缩/解压缩效率很低。还有一些算法的压缩/解压缩效率很高，但压缩比很低。因此，一个优秀的压缩算法需平衡压缩比和压缩效率两个因素当前有多种可选的压缩格式如：gzip,zip,bzip2,LZO,Snapy等。  

8. 设置预读取功能开启  
预读取机制可以有效提高磁盘IO读数据性能。由于Hadoop是顺序读系统。采用预读取机制可明显提高HDFS读性能和MapReduce作业执行效率  

9. 在Map阶段启用Combiner过程，可以使用Reduce函数也可以自己定义，但是自定义的Combiner类需要是继承自Reduce[10]。开启了Combiner过程后，会将MapTask的输出数据进行一定程度的合并。这样减少了从MapTask节点到ReduceTask节点的传输数据量。进而提高数据传输效率，减少了作业的运行时间。  